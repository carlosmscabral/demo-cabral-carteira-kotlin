# 04-Data-Model.md

## Database Overview
The application follows an **Offline-First** architecture using **Room (SQLite)** for local persistence. The schema is optimized for speed, ensuring that write operations for new transactions are near-instantaneous. To maintain data integrity and support future features like "Smart Suggestions," the model includes spatial data for local geofencing.

---

## SQL Schema

```sql
-- Categories Table: Pre-populated with defaults, customizable by user
CREATE TABLE categories (
    id UUID PRIMARY KEY,
    name VARCHAR(50) NOT NULL,
    icon_alias VARCHAR(30) NOT NULL, -- e.g., "burger", "car", "coffee"
    color_hex CHAR(7) NOT NULL,      -- e.g., "#EC4899"
    is_default BOOLEAN DEFAULT FALSE,
    display_order INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Locations Table: Stores local GPS coordinates for Smart Suggestions
CREATE TABLE locations (
    id UUID PRIMARY KEY,
    place_name VARCHAR(100),
    latitude DECIMAL(10, 8) NOT NULL,
    longitude DECIMAL(11, 8) NOT NULL,
    radius_meters INTEGER DEFAULT 50,
    category_id UUID,
    hit_count INTEGER DEFAULT 1,
    FOREIGN KEY (category_id) REFERENCES categories(id) ON DELETE SET NULL
);

-- Transactions Table: The core ledger
CREATE TABLE transactions (
    id UUID PRIMARY KEY,
    amount_cents INTEGER NOT NULL,    -- Stored in cents to avoid floating point errors
    currency_code VARCHAR(3) DEFAULT 'BRL',
    description VARCHAR(255),
    category_id UUID NOT NULL,
    location_id UUID,
    transaction_type VARCHAR(10) CHECK (transaction_type IN ('EXPENSE', 'INCOME')),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_manual BOOLEAN DEFAULT TRUE,  -- False if generated by recurring_rules
    FOREIGN KEY (category_id) REFERENCES categories(id),
    FOREIGN KEY (location_id) REFERENCES locations(id)
);

-- Recurring Rules Table: For the "Manual Automation" engine
CREATE TABLE recurring_rules (
    id UUID PRIMARY KEY,
    amount_cents INTEGER NOT NULL,
    category_id UUID NOT NULL,
    description VARCHAR(255),
    frequency VARCHAR(20) CHECK (frequency IN ('DAILY', 'WEEKLY', 'MONTHLY', 'YEARLY')),
    day_of_period INTEGER NOT NULL,  -- Day of month or day of week
    is_active BOOLEAN DEFAULT TRUE,
    start_date DATE NOT NULL,
    last_processed_date DATE,
    FOREIGN KEY (category_id) REFERENCES categories(id)
);

-- Indices for Performance
CREATE INDEX idx_transaction_date ON transactions(created_at);
CREATE INDEX idx_location_coords ON locations(latitude, longitude);
```

---

## Entity Relationships

### 1. Categories & Transactions (1:N)
Each transaction must be linked to a single category. Categories act as the primary filter for the "Calculadora-First" UI, where a category tap finalizes the entry.

### 2. Locations & Transactions (1:N)
A transaction may optionally contain location metadata. This allows the "Smart Suggestion" engine to query the `locations` table:
- *Query:* "Find location within 50m of current GPS."
- *Action:* If found, move the linked `category_id` to the top of the UI list.

### 3. Recurring Rules & Transactions (1:N)
The `recurring_rules` table acts as a template. A background Worker (WorkManager) checks this table daily. If the condition is met (e.g., today is the 5th), it inserts a new record into `transactions` with `is_manual = FALSE`.

### 4. Categories & Locations (1:N)
A specific physical location can be mapped to a preferred category (e.g., "Carrefour" -> "Groceries"). This mapping strengthens the "0-click" selection logic when the user is physically at the venue.

---

## Data Constraints & Logic
- **Precision:** Amounts are stored as `INTEGER` (cents) to ensure 100% accuracy during mathematical operations, preventing rounding issues common with `FLOAT`.
- **Privacy:** No User ID or Device ID fields are present. All data is localized.
- **Performance:** `idx_transaction_date` ensures that the Dashboard and History views load instantly even with thousands of entries.
- **Flexibility:** The `icon_alias` string maps to local Android vector drawables (Vector Assets) to keep the database lightweight.